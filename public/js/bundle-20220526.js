!function(t){"use strict";if(!t.fetch){var s={searchParams:"URLSearchParams"in t,iterable:"Symbol"in t&&"iterator"in Symbol,blob:"FileReader"in t&&"Blob"in t&&function(){try{return new Blob,!0}catch(t){return!1}}(),formData:"FormData"in t,arrayBuffer:"ArrayBuffer"in t};if(s.arrayBuffer)var e=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],r=function(t){return t&&DataView.prototype.isPrototypeOf(t)},o=ArrayBuffer.isView||function(t){return t&&-1<e.indexOf(Object.prototype.toString.call(t))};f.prototype.append=function(t,e){t=a(t),e=h(e);var r=this.map[t];this.map[t]=r?r+","+e:e},f.prototype.delete=function(t){delete this.map[a(t)]},f.prototype.get=function(t){return t=a(t),this.has(t)?this.map[t]:null},f.prototype.has=function(t){return this.map.hasOwnProperty(a(t))},f.prototype.set=function(t,e){this.map[a(t)]=h(e)},f.prototype.forEach=function(t,e){for(var r in this.map)this.map.hasOwnProperty(r)&&t.call(e,this.map[r],r,this)},f.prototype.keys=function(){var r=[];return this.forEach(function(t,e){r.push(e)}),u(r)},f.prototype.values=function(){var e=[];return this.forEach(function(t){e.push(t)}),u(e)},f.prototype.entries=function(){var r=[];return this.forEach(function(t,e){r.push([e,t])}),u(r)},s.iterable&&(f.prototype[Symbol.iterator]=f.prototype.entries);var i=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];b.prototype.clone=function(){return new b(this,{body:this._bodyInit})},c.call(b.prototype),c.call(w.prototype),w.prototype.clone=function(){return new w(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new f(this.headers),url:this.url})},w.error=function(){var t=new w(null,{status:0,statusText:""});return t.type="error",t};var n=[301,302,303,307,308];w.redirect=function(t,e){if(-1===n.indexOf(e))throw new RangeError("Invalid status code");return new w(null,{status:e,headers:{location:t}})},t.Headers=f,t.Request=b,t.Response=w,t.fetch=function(r,n){return new Promise(function(o,t){var e=new b(r,n),i=new XMLHttpRequest;i.onload=function(){var t,n,e={status:i.status,statusText:i.statusText,headers:(t=i.getAllResponseHeaders()||"",n=new f,t.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach(function(t){var e=t.split(":"),r=e.shift().trim();if(r){var o=e.join(":").trim();n.append(r,o)}}),n)};e.url="responseURL"in i?i.responseURL:e.headers.get("X-Request-URL");var r="response"in i?i.response:i.responseText;o(new w(r,e))},i.onerror=function(){t(new TypeError("Network request failed"))},i.ontimeout=function(){t(new TypeError("Network request failed"))},i.open(e.method,e.url,!0),"include"===e.credentials?i.withCredentials=!0:"omit"===e.credentials&&(i.withCredentials=!1),"responseType"in i&&s.blob&&(i.responseType="blob"),e.headers.forEach(function(t,e){i.setRequestHeader(e,t)}),i.send(void 0===e._bodyInit?null:e._bodyInit)})},t.fetch.polyfill=!0}function a(t){if("string"!=typeof t&&(t=String(t)),/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function h(t){return"string"!=typeof t&&(t=String(t)),t}function u(e){var t={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return s.iterable&&(t[Symbol.iterator]=function(){return t}),t}function f(e){this.map={},e instanceof f?e.forEach(function(t,e){this.append(e,t)},this):Array.isArray(e)?e.forEach(function(t){this.append(t[0],t[1])},this):e&&Object.getOwnPropertyNames(e).forEach(function(t){this.append(t,e[t])},this)}function d(t){if(t.bodyUsed)return Promise.reject(new TypeError("Already read"));t.bodyUsed=!0}function y(r){return new Promise(function(t,e){r.onload=function(){t(r.result)},r.onerror=function(){e(r.error)}})}function l(t){var e=new FileReader,r=y(e);return e.readAsArrayBuffer(t),r}function p(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);return e.set(new Uint8Array(t)),e.buffer}function c(){return this.bodyUsed=!1,this._initBody=function(t){if(this._bodyInit=t)if("string"==typeof t)this._bodyText=t;else if(s.blob&&Blob.prototype.isPrototypeOf(t))this._bodyBlob=t;else if(s.formData&&FormData.prototype.isPrototypeOf(t))this._bodyFormData=t;else if(s.searchParams&&URLSearchParams.prototype.isPrototypeOf(t))this._bodyText=t.toString();else if(s.arrayBuffer&&s.blob&&r(t))this._bodyArrayBuffer=p(t.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer]);else{if(!s.arrayBuffer||!ArrayBuffer.prototype.isPrototypeOf(t)&&!o(t))throw new Error("unsupported BodyInit type");this._bodyArrayBuffer=p(t)}else this._bodyText="";this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):s.searchParams&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},s.blob&&(this.blob=function(){var t=d(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?d(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(l)}),this.text=function(){var t,e,r,o=d(this);if(o)return o;if(this._bodyBlob)return t=this._bodyBlob,e=new FileReader,r=y(e),e.readAsText(t),r;if(this._bodyArrayBuffer)return Promise.resolve(function(t){for(var e=new Uint8Array(t),r=new Array(e.length),o=0;o<e.length;o++)r[o]=String.fromCharCode(e[o]);return r.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},s.formData&&(this.formData=function(){return this.text().then(m)}),this.json=function(){return this.text().then(JSON.parse)},this}function b(t,e){var r,o,n=(e=e||{}).body;if(t instanceof b){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url,this.credentials=t.credentials,e.headers||(this.headers=new f(t.headers)),this.method=t.method,this.mode=t.mode,n||null==t._bodyInit||(n=t._bodyInit,t.bodyUsed=!0)}else this.url=String(t);if(this.credentials=e.credentials||this.credentials||"omit",!e.headers&&this.headers||(this.headers=new f(e.headers)),this.method=(r=e.method||this.method||"GET",o=r.toUpperCase(),-1<i.indexOf(o)?o:r),this.mode=e.mode||this.mode||null,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&n)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(n)}function m(t){var n=new FormData;return t.trim().split("&").forEach(function(t){if(t){var e=t.split("="),r=e.shift().replace(/\+/g," "),o=e.join("=").replace(/\+/g," ");n.append(decodeURIComponent(r),decodeURIComponent(o))}}),n}function w(t,e){e||(e={}),this.type="default",this.status=void 0===e.status?200:e.status,this.ok=200<=this.status&&this.status<300,this.statusText="statusText"in e?e.statusText:"OK",this.headers=new f(e.headers),this.url=e.url||"",this._initBody(t)}}("undefined"!=typeof self?self:this);var autoComplete=function(){function e(e){function t(e,t){return e.classList?e.classList.contains(t):new RegExp("\\b"+t+"\\b").test(e.className)}function o(e,t,o){e.attachEvent?e.attachEvent("on"+t,o):e.addEventListener(t,o)}function s(e,t,o){e.detachEvent?e.detachEvent("on"+t,o):e.removeEventListener(t,o)}function n(e,s,n,l){o(l||document,s,function(o){for(var s,l=o.target||o.srcElement;l&&!(s=t(l,e));)l=l.parentElement;s&&n.call(l,o)})}if(document.querySelector){var l={selector:0,source:0,minChars:3,delay:150,offsetLeft:0,offsetTop:1,cache:1,menuClass:"",renderItem:function(e,t){t=t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");var o=new RegExp("("+t.split(" ").join("|")+")","gi");return'<div class="autocomplete-suggestion" data-val="'+e+'">'+e.replace(o,"<b>$1</b>")+"</div>"},onSelect:function(){}};for(var c in e)e.hasOwnProperty(c)&&(l[c]=e[c]);for(var a="object"==typeof l.selector?[l.selector]:document.querySelectorAll(l.selector),u=0;u<a.length;u++){var i=a[u];i.sc=document.createElement("div"),i.sc.className="autocomplete-suggestions "+l.menuClass,i.autocompleteAttr=i.getAttribute("autocomplete"),i.setAttribute("autocomplete","off"),i.cache={},i.last_val="",i.updateSC=function(e,t){var o=i.getBoundingClientRect();if(i.sc.style.left=Math.round(o.left+(window.pageXOffset||document.documentElement.scrollLeft)+l.offsetLeft)+"px",i.sc.style.top=Math.round(o.bottom+(window.pageYOffset||document.documentElement.scrollTop)+l.offsetTop)+"px",i.sc.style.width=Math.round(o.right-o.left)+"px",!e&&(i.sc.style.display="block",i.sc.maxHeight||(i.sc.maxHeight=parseInt((window.getComputedStyle?getComputedStyle(i.sc,null):i.sc.currentStyle).maxHeight)),i.sc.suggestionHeight||(i.sc.suggestionHeight=i.sc.querySelector(".autocomplete-suggestion").offsetHeight),i.sc.suggestionHeight))if(t){var s=i.sc.scrollTop,n=t.getBoundingClientRect().top-i.sc.getBoundingClientRect().top;n+i.sc.suggestionHeight-i.sc.maxHeight>0?i.sc.scrollTop=n+i.sc.suggestionHeight+s-i.sc.maxHeight:0>n&&(i.sc.scrollTop=n+s)}else i.sc.scrollTop=0},o(window,"resize",i.updateSC),document.body.appendChild(i.sc),n("autocomplete-suggestion","mouseleave",function(){var e=i.sc.querySelector(".autocomplete-suggestion.selected");e&&setTimeout(function(){e.className=e.className.replace("selected","")},20)},i.sc),n("autocomplete-suggestion","mouseover",function(){var e=i.sc.querySelector(".autocomplete-suggestion.selected");e&&(e.className=e.className.replace("selected","")),this.className+=" selected"},i.sc),n("autocomplete-suggestion","mousedown",function(e){if(t(this,"autocomplete-suggestion")){var o=this.getAttribute("data-val");i.value=o,l.onSelect(e,o,this),i.sc.style.display="none"}},i.sc),i.blurHandler=function(){try{var e=document.querySelector(".autocomplete-suggestions:hover")}catch(t){var e=0}e?i!==document.activeElement&&setTimeout(function(){i.focus()},20):(i.last_val=i.value,i.sc.style.display="none",setTimeout(function(){i.sc.style.display="none"},350))},o(i,"blur",i.blurHandler);var r=function(e){var t=i.value;if(i.cache[t]=e,e.length&&t.length>=l.minChars){for(var o="",s=0;s<e.length;s++)o+=l.renderItem(e[s],t);i.sc.innerHTML=o,i.updateSC(0)}else i.sc.style.display="none"};i.keydownHandler=function(e){var t=window.event?e.keyCode:e.which;if((40==t||38==t)&&i.sc.innerHTML){var o,s=i.sc.querySelector(".autocomplete-suggestion.selected");return s?(o=40==t?s.nextSibling:s.previousSibling,o?(s.className=s.className.replace("selected",""),o.className+=" selected",i.value=o.getAttribute("data-val")):(s.className=s.className.replace("selected",""),i.value=i.last_val,o=0)):(o=40==t?i.sc.querySelector(".autocomplete-suggestion"):i.sc.childNodes[i.sc.childNodes.length-1],o.className+=" selected",i.value=o.getAttribute("data-val")),i.updateSC(0,o),!1}if(27==t)i.value=i.last_val,i.sc.style.display="none";else if(13==t||9==t){var s=i.sc.querySelector(".autocomplete-suggestion.selected");s&&"none"!=i.sc.style.display&&(l.onSelect(e,s.getAttribute("data-val"),s),setTimeout(function(){i.sc.style.display="none"},20))}},o(i,"keydown",i.keydownHandler),i.keyupHandler=function(e){var t=window.event?e.keyCode:e.which;if(!t||(35>t||t>40)&&13!=t&&27!=t){var o=i.value;if(o.length>=l.minChars){if(o!=i.last_val){if(i.last_val=o,clearTimeout(i.timer),l.cache){if(o in i.cache)return void r(i.cache[o]);for(var s=1;s<o.length-l.minChars;s++){var n=o.slice(0,o.length-s);if(n in i.cache&&!i.cache[n].length)return void r([])}}i.timer=setTimeout(function(){l.source(o,r)},l.delay)}}else i.last_val=o,i.sc.style.display="none"}},o(i,"keyup",i.keyupHandler),i.focusHandler=function(e){i.last_val="\n",i.keyupHandler(e)},l.minChars||o(i,"focus",i.focusHandler)}this.destroy=function(){for(var e=0;e<a.length;e++){var t=a[e];s(window,"resize",t.updateSC),s(t,"blur",t.blurHandler),s(t,"focus",t.focusHandler),s(t,"keydown",t.keydownHandler),s(t,"keyup",t.keyupHandler),t.autocompleteAttr?t.setAttribute("autocomplete",t.autocompleteAttr):t.removeAttribute("autocomplete"),document.body.removeChild(t.sc),t=null}}}}return e}();!function(){"function"==typeof define&&define.amd?define("autoComplete",function(){return autoComplete}):"undefined"!=typeof module&&module.exports?module.exports=autoComplete:window.autoComplete=autoComplete}();"use strict";void 0===Date.now&&(Date.now=function(){return(new Date).valueOf()});var TWEEN=TWEEN||function(){var a=[];return{REVISION:"14",getAll:function(){return a},removeAll:function(){a=[]},add:function(c){a.push(c)},remove:function(c){c=a.indexOf(c);-1!==c&&a.splice(c,1)},update:function(c){if(0===a.length)return!1;for(var b=0,c=void 0!==c?c:"undefined"!==typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now();b<a.length;)a[b].update(c)?b++:a.splice(b,1);return!0}}}();TWEEN.Tween=function(a){var c={},b={},d={},e=1e3,g=0,h=!1,j=!1,q=0,m=null,w=TWEEN.Easing.Linear.None,x=TWEEN.Interpolation.Linear,n=[],r=null,s=!1,t=null,u=null,k=null,v;for(v in a)c[v]=parseFloat(a[v],10);this.to=function(a,c){void 0!==c&&(e=c);b=a;return this};this.start=function(e){TWEEN.add(this);j=!0;s=!1;m=void 0!==e?e:"undefined"!==typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now();m+=q;for(var f in b){if(b[f]instanceof Array){if(0===b[f].length)continue;b[f]=[a[f]].concat(b[f])}c[f]=a[f];!1===c[f]instanceof Array&&(c[f]*=1);d[f]=c[f]||0}return this};this.stop=function(){if(!j)return this;TWEEN.remove(this);j=!1;null!==k&&k.call(a);this.stopChainedTweens();return this};this.stopChainedTweens=function(){for(var a=0,b=n.length;a<b;a++)n[a].stop()};this.delay=function(a){q=a;return this};this.repeat=function(a){g=a;return this};this.yoyo=function(a){h=a;return this};this.easing=function(a){w=a;return this};this.interpolation=function(a){x=a;return this};this.chain=function(){n=arguments;return this};this.onStart=function(a){r=a;return this};this.onUpdate=function(a){t=a;return this};this.onComplete=function(a){u=a;return this};this.onStop=function(a){k=a;return this};this.update=function(p){var f;if(p<m)return!0;!1===s&&(null!==r&&r.call(a),s=!0);var i=(p-m)/e,i=1<i?1:i,j=w(i);for(f in b){var k=c[f]||0,l=b[f];l instanceof Array?a[f]=x(l,j):("string"===typeof l&&(l=k+parseFloat(l,10)),"number"===typeof l&&(a[f]=k+(l-k)*j))}null!==t&&t.call(a,j);if(1==i)if(0<g){isFinite(g)&&g--;for(f in d)"string"===typeof b[f]&&(d[f]+=parseFloat(b[f],10)),h&&(i=d[f],d[f]=b[f],b[f]=i),c[f]=d[f];m=p+q}else{null!==u&&u.call(a);f=0;for(i=n.length;f<i;f++)n[f].start(p);return!1}return!0}};TWEEN.Easing={Linear:{None:function(a){return a}},Quadratic:{In:function(a){return a*a},Out:function(a){return a*(2-a)},InOut:function(a){return 1>(a*=2)?.5*a*a:-.5*(--a*(a-2)-1)}},Cubic:{In:function(a){return a*a*a},Out:function(a){return--a*a*a+1},InOut:function(a){return 1>(a*=2)?.5*a*a*a:.5*((a-=2)*a*a+2)}},Quartic:{In:function(a){return a*a*a*a},Out:function(a){return 1- --a*a*a*a},InOut:function(a){return 1>(a*=2)?.5*a*a*a*a:-.5*((a-=2)*a*a*a-2)}},Quintic:{In:function(a){return a*a*a*a*a},Out:function(a){return--a*a*a*a*a+1},InOut:function(a){return 1>(a*=2)?.5*a*a*a*a*a:.5*((a-=2)*a*a*a*a+2)}},Sinusoidal:{In:function(a){return 1-Math.cos(a*Math.PI/2)},Out:function(a){return Math.sin(a*Math.PI/2)},InOut:function(a){return.5*(1-Math.cos(Math.PI*a))}},Exponential:{In:function(a){return 0===a?0:Math.pow(1024,a-1)},Out:function(a){return 1===a?1:1-Math.pow(2,-10*a)},InOut:function(a){return 0===a?0:1===a?1:1>(a*=2)?.5*Math.pow(1024,a-1):.5*(-Math.pow(2,-10*(a-1))+2)}},Circular:{In:function(a){return 1-Math.sqrt(1-a*a)},Out:function(a){return Math.sqrt(1- --a*a)},InOut:function(a){return 1>(a*=2)?-.5*(Math.sqrt(1-a*a)-1):.5*(Math.sqrt(1-(a-=2)*a)+1)}},Elastic:{In:function(a){var c,b=.1;if(0===a)return 0;if(1===a)return 1;!b||1>b?(b=1,c=.1):c=.4*Math.asin(1/b)/(2*Math.PI);return-(b*Math.pow(2,10*(a-=1))*Math.sin((a-c)*2*Math.PI/.4))},Out:function(a){var c,b=.1;if(0===a)return 0;if(1===a)return 1;!b||1>b?(b=1,c=.1):c=.4*Math.asin(1/b)/(2*Math.PI);return b*Math.pow(2,-10*a)*Math.sin((a-c)*2*Math.PI/.4)+1},InOut:function(a){var c,b=.1;if(0===a)return 0;if(1===a)return 1;!b||1>b?(b=1,c=.1):c=.4*Math.asin(1/b)/(2*Math.PI);return 1>(a*=2)?-.5*b*Math.pow(2,10*(a-=1))*Math.sin((a-c)*2*Math.PI/.4):.5*b*Math.pow(2,-10*(a-=1))*Math.sin((a-c)*2*Math.PI/.4)+1}},Back:{In:function(a){return a*a*(2.70158*a-1.70158)},Out:function(a){return--a*a*(2.70158*a+1.70158)+1},InOut:function(a){return 1>(a*=2)?.5*a*a*(3.5949095*a-2.5949095):.5*((a-=2)*a*(3.5949095*a+2.5949095)+2)}},Bounce:{In:function(a){return 1-TWEEN.Easing.Bounce.Out(1-a)},Out:function(a){return a<1/2.75?7.5625*a*a:a<2/2.75?7.5625*(a-=1.5/2.75)*a+.75:a<2.5/2.75?7.5625*(a-=2.25/2.75)*a+.9375:7.5625*(a-=2.625/2.75)*a+.984375},InOut:function(a){return.5>a?.5*TWEEN.Easing.Bounce.In(2*a):.5*TWEEN.Easing.Bounce.Out(2*a-1)+.5}}};TWEEN.Interpolation={Linear:function(a,c){var b=a.length-1,d=b*c,e=Math.floor(d),g=TWEEN.Interpolation.Utils.Linear;return 0>c?g(a[0],a[1],d):1<c?g(a[b],a[b-1],b-d):g(a[e],a[e+1>b?b:e+1],d-e)},Bezier:function(a,c){var b=0,d=a.length-1,e=Math.pow,g=TWEEN.Interpolation.Utils.Bernstein,h;for(h=0;h<=d;h++)b+=e(1-c,d-h)*e(c,h)*a[h]*g(d,h);return b},CatmullRom:function(a,c){var b=a.length-1,d=b*c,e=Math.floor(d),g=TWEEN.Interpolation.Utils.CatmullRom;return a[0]===a[b]?(0>c&&(e=Math.floor(d=b*(1+c))),g(a[(e-1+b)%b],a[e],a[(e+1)%b],a[(e+2)%b],d-e)):0>c?a[0]-(g(a[0],a[0],a[1],a[1],-d)-a[0]):1<c?a[b]-(g(a[b],a[b],a[b-1],a[b-1],d-b)-a[b]):g(a[e?e-1:0],a[e],a[b<e+1?b:e+1],a[b<e+2?b:e+2],d-e)},Utils:{Linear:function(a,c,b){return(c-a)*b+a},Bernstein:function(a,c){var b=TWEEN.Interpolation.Utils.Factorial;return b(a)/b(c)/b(a-c)},Factorial:function(){var a=[1];return function(c){var b=1,d;if(a[c])return a[c];for(d=c;1<d;d--)b*=d;return a[c]=b}}(),CatmullRom:function(a,c,b,d,e){var a=.5*(b-a),d=.5*(d-c),g=e*e;return(2*c-2*b+a+d)*e*g+(-3*c+3*b-2*a-d)*g+a*e+c}}};var THREEx=THREEx||{};THREEx.WindowResize=function(renderer,camera){var callback=function(){renderer.setSize(window.innerWidth,window.innerHeight);camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix()};window.addEventListener("resize",callback,false);return{stop:function(){window.removeEventListener("resize",callback)}}};THREE.OrbitControls=function(object,domElement){this.object=object;this.domElement=domElement!==undefined?domElement:document;this.enabled=true;this.target=new THREE.Vector3;this.center=this.target;this.noZoom=false;this.zoomSpeed=1;this.minDistance=0;this.maxDistance=Infinity;this.minZoom=0;this.maxZoom=Infinity;this.noRotate=false;this.rotateSpeed=1;this.noPan=false;this.keyPanSpeed=7;this.autoRotate=false;this.autoRotateSpeed=2;this.minPolarAngle=0;this.maxPolarAngle=Math.PI;this.minAzimuthAngle=-Infinity;this.maxAzimuthAngle=Infinity;this.noKeys=false;this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,ZOOM:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT};var scope=this;var EPS=1e-6;var rotateStart=new THREE.Vector2;var rotateEnd=new THREE.Vector2;var rotateDelta=new THREE.Vector2;var panStart=new THREE.Vector2;var panEnd=new THREE.Vector2;var panDelta=new THREE.Vector2;var panOffset=new THREE.Vector3;var offset=new THREE.Vector3;var dollyStart=new THREE.Vector2;var dollyEnd=new THREE.Vector2;var dollyDelta=new THREE.Vector2;var theta;var phi;var phiDelta=0;var thetaDelta=0;var scale=1;var pan=new THREE.Vector3;var lastPosition=new THREE.Vector3;var lastQuaternion=new THREE.Quaternion;var STATE={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5};var state=STATE.NONE;this.target0=this.target.clone();this.position0=this.object.position.clone();this.zoom0=this.object.zoom;var quat=(new THREE.Quaternion).setFromUnitVectors(object.up,new THREE.Vector3(0,1,0));var quatInverse=quat.clone().inverse();var changeEvent={type:"change"};var startEvent={type:"start"};var endEvent={type:"end"};this.rotateLeft=function(angle){if(angle===undefined){angle=getAutoRotationAngle()}thetaDelta-=angle};this.rotateUp=function(angle){if(angle===undefined){angle=getAutoRotationAngle()}phiDelta-=angle};this.panLeft=function(distance){var te=this.object.matrix.elements;panOffset.set(te[0],te[1],te[2]);panOffset.multiplyScalar(-distance);pan.add(panOffset)};this.panUp=function(distance){var te=this.object.matrix.elements;panOffset.set(te[4],te[5],te[6]);panOffset.multiplyScalar(distance);pan.add(panOffset)};this.pan=function(deltaX,deltaY){var element=scope.domElement===document?scope.domElement.body:scope.domElement;if(scope.object instanceof THREE.PerspectiveCamera){var position=scope.object.position;var offset=position.clone().sub(scope.target);var targetDistance=offset.length();targetDistance*=Math.tan(scope.object.fov/2*Math.PI/180);scope.panLeft(2*deltaX*targetDistance/element.clientHeight);scope.panUp(2*deltaY*targetDistance/element.clientHeight)}else if(scope.object instanceof THREE.OrthographicCamera){scope.panLeft(deltaX*(scope.object.right-scope.object.left)/element.clientWidth);scope.panUp(deltaY*(scope.object.top-scope.object.bottom)/element.clientHeight)}else{console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")}};this.dollyIn=function(dollyScale){if(dollyScale===undefined){dollyScale=getZoomScale()}if(scope.object instanceof THREE.PerspectiveCamera){scale/=dollyScale}else if(scope.object instanceof THREE.OrthographicCamera){scope.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom*dollyScale));scope.object.updateProjectionMatrix();scope.dispatchEvent(changeEvent)}else{console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.")}};this.dollyOut=function(dollyScale){if(dollyScale===undefined){dollyScale=getZoomScale()}if(scope.object instanceof THREE.PerspectiveCamera){scale*=dollyScale}else if(scope.object instanceof THREE.OrthographicCamera){scope.object.zoom=Math.max(this.minZoom,Math.min(this.maxZoom,this.object.zoom/dollyScale));scope.object.updateProjectionMatrix();scope.dispatchEvent(changeEvent)}else{console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled.")}};this.update=function(){var position=this.object.position;offset.copy(position).sub(this.target);offset.applyQuaternion(quat);theta=Math.atan2(offset.x,offset.z);phi=Math.atan2(Math.sqrt(offset.x*offset.x+offset.z*offset.z),offset.y);if(this.autoRotate&&state===STATE.NONE){this.rotateLeft(getAutoRotationAngle())}theta+=thetaDelta;phi+=phiDelta;theta=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,theta));phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,phi));phi=Math.max(EPS,Math.min(Math.PI-EPS,phi));var radius=offset.length()*scale;radius=Math.max(this.minDistance,Math.min(this.maxDistance,radius));this.target.add(pan);offset.x=radius*Math.sin(phi)*Math.sin(theta);offset.y=radius*Math.cos(phi);offset.z=radius*Math.sin(phi)*Math.cos(theta);offset.applyQuaternion(quatInverse);position.copy(this.target).add(offset);this.object.lookAt(this.target);thetaDelta=0;phiDelta=0;scale=1;pan.set(0,0,0);if(lastPosition.distanceToSquared(this.object.position)>EPS||8*(1-lastQuaternion.dot(this.object.quaternion))>EPS){this.dispatchEvent(changeEvent);lastPosition.copy(this.object.position);lastQuaternion.copy(this.object.quaternion)}};this.reset=function(){state=STATE.NONE;this.target.copy(this.target0);this.object.position.copy(this.position0);this.object.zoom=this.zoom0;this.object.updateProjectionMatrix();this.dispatchEvent(changeEvent);this.update()};this.getPolarAngle=function(){return phi};this.getAzimuthalAngle=function(){return theta};function getAutoRotationAngle(){return 2*Math.PI/60/60*scope.autoRotateSpeed}function getZoomScale(){return Math.pow(.95,scope.zoomSpeed)}function onMouseDown(event){if(scope.enabled===false)return;event.preventDefault();if(event.button===scope.mouseButtons.ORBIT){if(scope.noRotate===true)return;state=STATE.ROTATE;rotateStart.set(event.clientX,event.clientY)}else if(event.button===scope.mouseButtons.ZOOM){if(scope.noZoom===true)return;state=STATE.DOLLY;dollyStart.set(event.clientX,event.clientY)}else if(event.button===scope.mouseButtons.PAN){if(scope.noPan===true)return;state=STATE.PAN;panStart.set(event.clientX,event.clientY)}if(state!==STATE.NONE){document.addEventListener("mousemove",onMouseMove,false);document.addEventListener("mouseup",onMouseUp,false);scope.dispatchEvent(startEvent)}}function onMouseMove(event){if(scope.enabled===false)return;event.preventDefault();var element=scope.domElement===document?scope.domElement.body:scope.domElement;if(state===STATE.ROTATE){if(scope.noRotate===true)return;rotateEnd.set(event.clientX,event.clientY);rotateDelta.subVectors(rotateEnd,rotateStart);scope.rotateLeft(2*Math.PI*rotateDelta.x/element.clientWidth*scope.rotateSpeed);scope.rotateUp(2*Math.PI*rotateDelta.y/element.clientHeight*scope.rotateSpeed);rotateStart.copy(rotateEnd)}else if(state===STATE.DOLLY){if(scope.noZoom===true)return;dollyEnd.set(event.clientX,event.clientY);dollyDelta.subVectors(dollyEnd,dollyStart);if(dollyDelta.y>0){scope.dollyIn()}else if(dollyDelta.y<0){scope.dollyOut()}dollyStart.copy(dollyEnd)}else if(state===STATE.PAN){if(scope.noPan===true)return;panEnd.set(event.clientX,event.clientY);panDelta.subVectors(panEnd,panStart);scope.pan(panDelta.x,panDelta.y);panStart.copy(panEnd)}if(state!==STATE.NONE)scope.update()}function onMouseUp(){if(scope.enabled===false)return;document.removeEventListener("mousemove",onMouseMove,false);document.removeEventListener("mouseup",onMouseUp,false);scope.dispatchEvent(endEvent);state=STATE.NONE}function onMouseWheel(event){if(scope.enabled===false||scope.noZoom===true||state!==STATE.NONE)return;event.preventDefault();event.stopPropagation();var delta=0;if(event.wheelDelta!==undefined){delta=event.wheelDelta}else if(event.detail!==undefined){delta=-event.detail}if(delta>0){scope.dollyOut()}else if(delta<0){scope.dollyIn()}scope.update();scope.dispatchEvent(startEvent);scope.dispatchEvent(endEvent)}function onKeyDown(event){if(scope.enabled===false||scope.noKeys===true||scope.noPan===true)return;switch(event.keyCode){case scope.keys.UP:scope.pan(0,scope.keyPanSpeed);scope.update();break;case scope.keys.BOTTOM:scope.pan(0,-scope.keyPanSpeed);scope.update();break;case scope.keys.LEFT:scope.pan(scope.keyPanSpeed,0);scope.update();break;case scope.keys.RIGHT:scope.pan(-scope.keyPanSpeed,0);scope.update();break}}function touchstart(event){if(scope.enabled===false)return;switch(event.touches.length){case 1:if(scope.noRotate===true)return;state=STATE.TOUCH_ROTATE;rotateStart.set(event.touches[0].pageX,event.touches[0].pageY);break;case 2:if(scope.noZoom===true)return;state=STATE.TOUCH_DOLLY;var dx=event.touches[0].pageX-event.touches[1].pageX;var dy=event.touches[0].pageY-event.touches[1].pageY;var distance=Math.sqrt(dx*dx+dy*dy);dollyStart.set(0,distance);break;case 3:if(scope.noPan===true)return;state=STATE.TOUCH_PAN;panStart.set(event.touches[0].pageX,event.touches[0].pageY);break;default:state=STATE.NONE}if(state!==STATE.NONE)scope.dispatchEvent(startEvent)}function touchmove(event){if(scope.enabled===false)return;event.preventDefault();event.stopPropagation();var element=scope.domElement===document?scope.domElement.body:scope.domElement;switch(event.touches.length){case 1:if(scope.noRotate===true)return;if(state!==STATE.TOUCH_ROTATE)return;rotateEnd.set(event.touches[0].pageX,event.touches[0].pageY);rotateDelta.subVectors(rotateEnd,rotateStart);scope.rotateLeft(2*Math.PI*rotateDelta.x/element.clientWidth*scope.rotateSpeed);scope.rotateUp(2*Math.PI*rotateDelta.y/element.clientHeight*scope.rotateSpeed);rotateStart.copy(rotateEnd);scope.update();break;case 2:if(scope.noZoom===true)return;if(state!==STATE.TOUCH_DOLLY)return;var dx=event.touches[0].pageX-event.touches[1].pageX;var dy=event.touches[0].pageY-event.touches[1].pageY;var distance=Math.sqrt(dx*dx+dy*dy);dollyEnd.set(0,distance);dollyDelta.subVectors(dollyEnd,dollyStart);if(dollyDelta.y>0){scope.dollyOut()}else if(dollyDelta.y<0){scope.dollyIn()}dollyStart.copy(dollyEnd);scope.update();break;case 3:if(scope.noPan===true)return;if(state!==STATE.TOUCH_PAN)return;panEnd.set(event.touches[0].pageX,event.touches[0].pageY);panDelta.subVectors(panEnd,panStart);scope.pan(panDelta.x,panDelta.y);panStart.copy(panEnd);scope.update();break;default:state=STATE.NONE}}function touchend(){if(scope.enabled===false)return;scope.dispatchEvent(endEvent);state=STATE.NONE}this.domElement.addEventListener("contextmenu",function(event){event.preventDefault()},false);this.domElement.addEventListener("mousedown",onMouseDown,false);this.domElement.addEventListener("mousewheel",onMouseWheel,false);this.domElement.addEventListener("DOMMouseScroll",onMouseWheel,false);this.domElement.addEventListener("touchstart",touchstart,false);this.domElement.addEventListener("touchend",touchend,false);this.domElement.addEventListener("touchmove",touchmove,false);window.addEventListener("keydown",onKeyDown,false);this.update()};THREE.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype);THREE.OrbitControls.prototype.constructor=THREE.OrbitControls;var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var canvas=document.createElement("canvas");return!!window.WebGLRenderingContext&&(canvas.getContext("webgl")||canvas.getContext("experimental-webgl"))}catch(e){return false}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var element=document.createElement("div");element.className="webgl-error";if(!this.webgl){element.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/">here</a>.'].join("\n")}return element},addGetWebGLMessage:function(parent){parent.appendChild(Detector.getWebGLErrorMessage())}};(function(){var addressInput=document.getElementById("address-input-autocomplete");var addressList=document.getElementById("address-list");var addressWarning=document.getElementById("address-warning");var addressNearby=document.getElementById("address-nearby");var hinterCache={};var nameToLatlngs={};addressInput.onkeyup=function(e){var key=e.which||e.keyCode;if(key===13){tryAddressInput()}};var lastAddressFailed=true;window.addressInputYearChanged=function(){console.log("lastAddressFailed",lastAddressFailed);if(lastAddressFailed){tryAddressInput()}};function tryAddressInput(selectionLabel){var val=encodeURIComponent(selectionLabel||addressInput.value);var entry=hinterCache[val];if(entry){addressWarning.innerHTML="";mixpanel.track("Address select");ga("send","event","Ancient Earth","Address select");createMarkerWithLatlng({name:val,lat:entry[0],lng:entry[1]},true);return}if(val.length<1){return}addressWarning.innerHTML="Searching...";addressInput.disabled=true;fetch("/api/geocode/"+val).then(function(response){return response.json()}).then(function(obj){addressInput.disabled=false;addressWarning.innerHTML="";addressNearby.innerHTML="";if(obj.success){createMarkerWithLatlng(obj.data,true);mixpanel.track("Address lookup");ga("send","event","Ancient Earth","Address lookup")}else{mixpanel.track("Address lookup failure");ga("send","event","Ancient Earth","Address lookup failure");alert("Sorry, I don't have information on this city. Please try a different location.")}})}function hinter(val,suggest){fetch("/api/geocodeAutocomplete/"+encodeURIComponent(val)).then(function(response){return response.json()}).then(function(obj){if(obj.success){suggest(obj.data.map(function(item){hinterCache[item.label]=[item.lat,item.lng];return item.label}))}})}function createMarkerWithLatlng(place,shouldAnimate){var lat=place.lat;var lng=place.lng;var originalMya=window.getMya();fetch("/api/geo-reconstruct/"+originalMya+"?lat="+lat+"&lng="+lng).then(function(response){return response.json()}).then(function(obj){if(window.getMya()!==originalMya){console.warn("Restarting mya update");createMarkerWithLatlng(place,shouldAnimate);return}lastAddressFailed=false;if(!obj.success||!obj.data||!obj.data.lat||!obj.data.lng){addressWarning.innerHTML='<span class="red">Could not resolve location</span> for "'+place.name+"\"<br><br>Its tectonic plate doesn't track that far into the past - try switching to a more recent year!";addressNearby.innerHTML="";lastAddressFailed=true;return}if(obj.data.nearby&&obj.data.nearby.names.length>0){var links=obj.data.nearby.names.map(function(name){if(!nameToLatlngs[name]){nameToLatlngs[name]=obj.data.nearby.lookup[name]}return'<a target="_blank" data-name="'+name+'" href="/'+name+'-pictures">'+name+"</a>"});addressNearby.innerHTML="Nearby fossils: "+links.join(", ")}window.plotSurfaceMarker(obj.data.lat,obj.data.lng,function updateMarkerPosition(marker){createMarkerWithLatlng(place,true)},shouldAnimate)})}new autoComplete({selector:"#address-input-autocomplete",minChars:3,source:hinter,onSelect:function(e,term,item){tryAddressInput(term)}})})();(function(){var hideModal=function(){document.querySelectorAll(".modal-container").forEach(function(elt){elt.style.display="none"})};document.querySelectorAll(".modal-close").forEach(function(elt){elt.onclick=hideModal});document.querySelectorAll(".modal-container").forEach(function(elt){elt.onclick=hideModal});document.querySelectorAll(".modal-content").forEach(function(elt){elt.onclick=function(e){e.stopPropagation()}})})();var EXPLAIN_MAP={750:"Cryogenian Period.  Glaciers may have covered the entire planet during the greatest ice age known on Earth.  New types of life such as red and green algae appear during this period.",600:"Ediacaran Period.  Life is evolving in the sea, and multicellular life is just beginning to emerge. The Pannotia supercontinent is a major landmass.",540:'Early Cambrian.  A mass extinction has just taken place.  Afterwards, the fossil record shows a dramatic expansion of animal life in the sea, known as the "Cambrian explosion."  Animals are beginning to evolve shells and exoskeletons.',500:'Late Cambrian.  The ocean is teeming with life following a dramatic expansion of animal diversity in the sea, known as the "Cambrian explosion."  The forms of some animals show ancestry to modern animals.  Jawless fish, the first vertebrates, appear.',470:"Ordovician Period.  The seas are diverse and the first coral reefs emerge.  Algae is the only multicellular plant, and there is still no complex life on land.",450:"Late Ordovician.  The seas are diverse and the first coral reefs have emerged.  Algae is the only multicellular plant, and there is still no complex life on land.  A mass extinction is about to take place.",430:"Silurian Period.  A mass extinction took place, wiping out nearly half of marine invertebrate species.  The first land plants emerge, starting at the edge of the ocean.  Plants evolve vascularity, the ability to transport water and nutrients through their tissues.  Ocean life becomes larger and more complex, and some creatures venture out of reefs and onto land.",400:"Devonian Period.  Life on land becomes more complex as plants develop.  Insects diversify and fish develop sturdy fins, which eventually evolve into limbs.  The first vertebrates walk on land.  Oceans and coral reefs host a diverse range of fish, sharks, sea scorpions, and cephalopods.",370:"Late Devonian.  Life on land becomes more complex as plants develop.  Insects diversify and fish develop sturdy fins, which eventually evolve into limbs.  The first vertebrates walk on land.  Oceans and coral reefs host a diverse range of fish, sharks, sea scorpions, and cephalopods.  A mass extinction is about to take place that will stress marine life.",340:"Carboniferous Period.  A mass extinction harmed marine life, but land organisms adapted.  Plants are developing root systems that allowed them to grow larger and move inland.  Environments are evolving below tree canopies.  Atmospheric oxygen increases as plants spread on land.  Early reptiles are evolving.",300:"Late Carboniferous.  Plants developed root systems that allowed them to grow larger and move inland.  Environments evolved below tree canopies.  Atmospheric oxygen increased as plants spread on land.  Early reptiles have evolved, and giant insects diversify.",280:"Permian Period.  Landmasses merged and formed the supercontinent Pangea.  Extreme conditions such as polar ice caps and deserts limited the extent of plant life, but amphibious tetrapods and reptiles diversified where plants grew.  Oceans teemed with fish and invertebrate life.",260:"Late Permian.  The greatest mass extinction in history is about to take place, driving 90% of species extinct.  The extinction of plants reduced food supply for large herbivorous reptiles, and removed habitat for insects.",240:"Early Triassic.  Oxygen levels are significantly lower due to the extinction of many land plants.  Many corals went extinct, with reefs taking millions of years to re-form.  Small ancestors to birds, mammals, and dinosaurs survive on the Pangaea supercontinent.",220:"Middle Triassic.  The Earth is recovering from the Permian-Triassic extinction.  Small dinosaurs begin to appear.  Therapsids and archosaurs emerge, along with the first flying vertebrates.",200:"Late Triassic.  An extinction event is about to happen, resulting in the disappearance of 76% of all terrestrial and marine life species and greatly reducing surviving populations.  Some families, such as pterosaurs, crocodiles, mammals, and fish were minimally affected.  The first true dinosaurs emerge.",170:"Jurassic Period.  Dinosaurs thrived as the first mammals and birds evolved.  Ocean life diversified and the Earth was very warm.",150:"Late Jurassic.  The earliest lizards have appeared and primitive placental mammals have evolved.  Dinosaurs dominate both landmasses.  Large marine reptiles inhabited the ocean, and pterosaurs were the dominant flying vertebrates.",120:"Early Cretaceous.  The world is warm and has no polar ice caps.  Large reptiles dominate and mammals remained small.  Flowering plants evolve and spread throughout the world.",105:"Cretaceous Period.  Ceratopsian and pachycephalosaurid dinosaurs evolve.  Modern mammal, bird, and insect groups emerge.",90:"Cretaceous Period.  Ceratopsian and pachycephalosaurid dinosaurs evolve.  Modern mammal, bird, and insect groups emerge.",66:"Late Cretaceous.  A mass extinction occurs, leading to the extinction of dinosaurs, many marine reptiles, all flying reptiles, and many marine invertebrates and other species.  Scientists believe the extinction was caused by an asteroid impact on the present-day Yucatan Peninsula in Mexico.",50:"Early Tertiary.  Following the asteroid impact that killed the dinosaurs, surviving birds, mammals, and reptiles diversified.  Early whales evolved from land mammals.",35:"Mid Tertiary.  Mammals have evolved from small, simple forms to a diverse group.  Primates, cetaceans, and other groups evolve.  The Earth cools and deciduous plants become more common.",20:"Neocene Period.  Mammals and birds continue to evolve into modern forms.  Early hominids emerge in Africa.",0:""};(function(){"use strict";var webglEl=document.getElementById("webgl");if(!Detector.webgl){Detector.addGetWebGLMessage(webglEl);return}var DEFAULT_YEAR=240;var radius=1;var segments=32;var rotationY=4/3*Math.PI;var rotationX=0;var width=window.innerWidth;var height=window.innerHeight;var webParams=parseWebParams();var mya=webParams.startingYear;console.info("webParams:",webParams);var yearsago=document.getElementById("years-ago");var rotationEnabled=true;var simulationClicked=false;webglEl.addEventListener("mousedown",function(){simulationClicked=true},false);var scene=new THREE.Scene;var camera=new THREE.PerspectiveCamera(45,width/height,.01,1e3);camera.position.z=webParams.camera.zPos||4.5;window.cam=camera;var renderer=new THREE.WebGLRenderer({antialias:true});renderer.setSize(width,height);renderer.setClearColor(0);var dimLight=new THREE.AmbientLight(10066329);var brightLight=new THREE.AmbientLight(16777215);var ambientLight=dimLight;scene.add(ambientLight);var light=new THREE.DirectionalLight(16777215,1);light.position.set(5,3,5);scene.add(light);mya=webParams.startingYear;updateSelectWithValue();var sphereAndPoints=new THREE.Object3D;var customMarkers=[];var markers=[];if(webParams.surfacePoints.length>0){var point=webParams.surfacePoints[0];var rotationXY=latlngToXYRotation(point[0],point[1]);rotationX=rotationXY[0];rotationY=rotationXY[1]}var sphere;var loadedCount=0;yearsago.value=mya;onYearsAgoChanged();var clouds=createClouds(radius,segments);sphereAndPoints.add(clouds);scene.add(sphereAndPoints);var graticules=createGraticules();var stars=createStars(90,64);scene.add(stars);var controls=new THREE.OrbitControls(camera,webglEl);controls.minDistance=2;controls.maxDistance=10;controls.noKeys=true;var isMobile=window.matchMedia("only screen and (max-width: 760px)");if(isMobile.matches){controls.rotateSpeed=.7;controls.zoomSpeed=.2}else{controls.rotateSpeed=1.4}if(webParams.camera.noRotate){rotationEnabled=false}window.controls=controls;THREEx.WindowResize(renderer,camera);webglEl.appendChild(renderer.domElement);setupSelect();setupCredits();setupOptions();render();setTimeout(function(){preloadTextures()},2e4);function render(){controls.update();if(rotationEnabled){if(simulationClicked||window.hasDisplayData){rotationY+=5e-4;sphereAndPoints.rotation.y=rotationY}else{rotationY+=.001;sphereAndPoints.rotation.y=rotationY}}TWEEN.update();requestAnimationFrame(render);renderer.render(scene,camera)}function preloadTextures(){for(var key in EXPLAIN_MAP){var i=new Image;i.src=imagePathForYearsAgo(key)}}function updateSelectWithValue(){document.getElementById("how-long-ago").innerHTML=mya;var explanation=EXPLAIN_MAP[mya];if(window.displayData&&mya===window.displayData.reconstruction.mya){explanation+="<br><br>"+window.displayData.name+' marked in <span class="red">red</span>.'}document.getElementById("explanation").innerHTML=explanation}function onYearsAgoChanged(){mya=parseInt(yearsago.value,10);sphereAndPoints.remove(sphere);var img=imagePathForYearsAgo(mya);sphere=createSphere(radius,segments,img);sphereAndPoints.rotation.x=rotationX;sphereAndPoints.rotation.y=rotationY;sphereAndPoints.add(sphere);markers.forEach(function(marker){sphereAndPoints.remove(marker)});var oldCustomMarkers=customMarkers.slice();customMarkers=[];oldCustomMarkers.forEach(function(marker){updateMarkerPosition(marker)});if(window.hasDisplayData&&mya===window.displayData.reconstruction.mya){markers=createSurfaceMarkers(webParams.surfacePoints);markers.forEach(function(marker){sphereAndPoints.add(marker)})}addressInputYearChanged();updateSelectWithValue();document.getElementById("address-warning").innerHTML="";window.location.replace("#"+mya)}function setupSelect(){yearsago.onchange=onYearsAgoChanged;var t=-1;document.addEventListener("keydown",function(e){var now=(new Date).getTime();if(now-t>150&&(e.keyCode===37||e.keyCode===39)){var select=document.getElementById("years-ago");if(e.keyCode===37){select.selectedIndex=Math.max(select.selectedIndex-1,0)}else if(e.keyCode===39){select.selectedIndex=Math.min(select.selectedIndex+1,select.length-1)}select.dispatchEvent(new Event("change",{bubbles:true}));t=now}},false);var jumpToElt=document.getElementById("jump-to");jumpToElt.onchange=function(e){yearsago.value=jumpToElt.value;onYearsAgoChanged();e.target.blur()}}function imagePathForYearsAgo(year){return"/ancient-earth-assets/images/scotese/"+year+".jpg"}function createSphere(radius,segments,img){var map=THREE.ImageUtils.loadTexture(img,undefined,function(){if(++loadedCount>=2){document.getElementById("loading").style.display="none"}});map.minFilter=THREE.LinearFilter;var sphereGeometry=new THREE.SphereGeometry(radius,segments,segments);var mesh=new THREE.Mesh(sphereGeometry,new THREE.MeshPhongMaterial({map:map,color:12303291,shininess:0}));return mesh}function createGraticules(){var material=new THREE.LineBasicMaterial({color:14540253,transparent:true,opacity:.3});var geometry=new THREE.CircleGeometry(radius+.005,50);geometry.vertices.shift();var circle=new THREE.Line(geometry,material);circle.rotation.x=Math.PI/2;return[circle]}function createClouds(radius,segments){var map=THREE.ImageUtils.loadTexture("/ancient-earth-assets/images/fair_clouds_4k.png",undefined,function(){if(++loadedCount>=2){document.getElementById("loading").style.display="none"}});return new THREE.Mesh(new THREE.SphereGeometry(radius+.003,segments,segments),new THREE.MeshPhongMaterial({map:map,transparent:true,opacity:1}))}function createStars(radius,segments){var starsGeometry=new THREE.Geometry;for(var i=0;i<1e4;i++){var lat=THREE.Math.randFloatSpread(180);var lng=THREE.Math.randFloatSpread(360);var star=latLngToVector3(lat,lng,200+Math.random()*1e3,0);starsGeometry.vertices.push(star)}var starsMaterial=new THREE.PointsMaterial({color:8947848});return new THREE.Points(starsGeometry,starsMaterial)}function createSurfaceMarkers(latlngs,color,size){return latlngs.map(function(latlng){var pos=latLngToVector3(latlng[0],latlng[1]+180,radius,0);var sphereRadius=size||.008;var coneRadius=sphereRadius*.9;var height=sphereRadius*3;var material=new THREE.MeshPhongMaterial({color:14423100});var cone=new THREE.Mesh(new THREE.ConeBufferGeometry(coneRadius,height,8,1,true),material);cone.position.y=height*.5;cone.rotation.x=Math.PI;var sphere=new THREE.Mesh(new THREE.SphereBufferGeometry(sphereRadius,16,8),material);sphere.position.y=sphereRadius+height*.5;var marker=new THREE.Group;marker.add(sphere);marker.add(cone);var latRad=latlng[0]*(Math.PI/180);var lngRad=-latlng[1]*(Math.PI/180);marker.position.set(pos.x,pos.y,pos.z);marker.rotation.set(0,-lngRad,latRad-Math.PI*.5);return marker})}function latLngToVector3(lat,lng,radius,height){var phi=lat*Math.PI/180;var theta=lng*Math.PI/180;var x=-(radius+height)*Math.cos(phi)*Math.cos(theta);var y=(radius+height)*Math.sin(phi);var z=(radius+height)*Math.cos(phi)*Math.sin(theta);return new THREE.Vector3(x,y,z)}function parseWebParams(){var ret;if(window.hasDisplayData){ret={startingYear:window.displayData.reconstruction.mya,surfacePoints:window.displayData.reconstruction.latlngs}}else{ret={startingYear:DEFAULT_YEAR,surfacePoints:[]}}var hash=window.location.hash;if(hash){var paramsIdx=hash.indexOf("?");if(paramsIdx>-1){ret.startingYear=getNearestValidYear(parseInt(hash.slice(1,paramsIdx),10));ret.surfacePoints=JSON.parse(hash.slice(paramsIdx+1))}else{ret.startingYear=getNearestValidYear(parseInt(hash.slice(1),10))}if(window.hasDisplayData&&window.displayData.reconstruction.mya!==ret.startingYear){ret.surfacePoints=[]}}ret.camera={zPos:window.cameraZPos,noRotate:window.cameraNoRotate};return ret}function getNearestValidYear(year){if(!(year in EXPLAIN_MAP)){if(!year){console.error("Invalid year "+year)}var closestYear=null;var closestDiff=Number.MAX_VALUE;Object.keys(EXPLAIN_MAP).forEach(function(year2){var diff=Math.abs(year-year2);if(diff<closestDiff){closestDiff=diff;closestYear=year2}});console.warn("Invalid year "+year+", switching to closest year "+closestYear);return closestYear}return year}function latlngToXYRotation(lat,lng){var x=lat*(Math.PI/180)-.3;var y=(270-lng)*(Math.PI/180);return[x,y]}function setupCredits(){Array.from(document.getElementsByClassName("js-open-credits")).forEach(function(elt){elt.onclick=function(){document.getElementById("credits-modal").style.display="block"}})}function setupOptions(){Array.from(document.getElementsByClassName("js-open-options")).forEach(function(elt){elt.onclick=function(){document.getElementById("options-modal").style.display="block"}});var searchParams=new URL(window.location.href).searchParams;var cloudsElt=document.getElementById("toggle-clouds");cloudsElt.onclick=function(e){if(e.target.checked){sphereAndPoints.add(clouds)}else{sphereAndPoints.remove(clouds)}};if(searchParams.get("clouds")==="off"){sphereAndPoints.remove(clouds)}var rotateElt=document.getElementById("toggle-rotation");rotateElt.onclick=function(e){rotationEnabled=e.target.checked};if(searchParams.get("rotation")==="off"){rotationEnabled=false}var gratElt=document.getElementById("toggle-graticules");gratElt.onclick=function(e){graticules.forEach(function(grat){if(e.target.checked){sphereAndPoints.add(grat)}else{sphereAndPoints.remove(grat)}})};if(searchParams.get("graticules")==="on"){graticules.forEach(function(grat){sphereAndPoints.add(grat)})}var lightElt=document.getElementById("toggle-lighting");lightElt.onclick=function(e){if(e.target.checked){scene.add(brightLight);scene.remove(dimLight)}else{scene.remove(brightLight);scene.add(dimLight)}};if(searchParams.get("lighting")==="bright"){scene.add(brightLight);scene.remove(dimLight)}}function updateMarkerPosition(marker){sphereAndPoints.remove(marker);marker.__updateMarkerPositionFn(marker)}window.getMya=function(){return mya};window.plotSurfaceMarker=function(lat,lng,updateMarkerPositionFn,shouldAnimate){var markers=createSurfaceMarkers([[lat,lng]],16761035,.02);var marker=markers[0];marker.__updateMarkerPositionFn=updateMarkerPositionFn;customMarkers.push(marker);sphereAndPoints.add(marker);if(!shouldAnimate){return}rotationEnabled=false;document.getElementById("toggle-rotation").checked=false;var rotationXY=latlngToXYRotation(lat,lng);rotationX=rotationXY[0];rotationY=rotationXY[1];controls.noRotate=true;new TWEEN.Tween(sphereAndPoints.rotation).easing(TWEEN.Easing.Quadratic.InOut).to({x:rotationX,y:rotationY},2800).onComplete(function(){var count=0;var t=setInterval(function(){marker.visible=!marker.visible;if(count++>8){clearInterval(t)}},500);controls.noRotate=false}).start();var oldPos=controls.position0;new TWEEN.Tween(camera.position).easing(TWEEN.Easing.Linear.None).to({x:oldPos.x,y:oldPos.y,z:oldPos.z},3e3).start()}})();
