<script lang="ts">
	let events = [
		// DAILY (specific weekdays)
		{
			eventDate: "2025-04-08",
			eventTime: "10:00 AM",
			title: "üßò‚Äç‚ôÄÔ∏è Free YOGA BEACH TRIBE Class ‚Äì Find Your Zen! üåä",
			details: "Join us DAILY for a FREE yoga class where you can stretch, relax, and connect with your inner peace. üßò‚Äç‚ôÇÔ∏èüí´ This is a great chance to unwind, improve your flexibility, and meet like-minded people in a beautiful, peaceful environment. üßò‚Äç‚ôÄÔ∏è  What to bring? Yoga mat, but a towel works as well on the sand (or go mat-free and toughen up like a pro üòù) Come as you are! Come ready to relax, stretch, and flow. Who‚Äôs in? üëá",
			location: { name: "C√¥ng vi√™n Sao Bi·ªÉn Beach", link: "https://maps.app.goo.gl/XREbFP8pjKX9tqZY6" },
			category: "Yoga",
			frequency: "daily",
			weekdays: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
		},

		// WEEKLY
		{
			eventDate: "2025-04-13",
			eventTime: "6:00 PM",
			title: "ü§§ EAT LIKE A LOCAL üç≤üç¥",
			details: "Tired of touristy restaurants? Join us a few times per week for an authentic local food experience! We‚Äôre hitting up a hidden gem where a local grandma cooks the best, freshest, realest food you can get. No menus, just a spread of delicious home-cooked dishes ‚Äì buffet style! Check out the pics below ‚Äì this is the kind of food we‚Äôll be enjoying! üçõ üõë No menus ‚úÖ Depending on the location, we will either enjoy a buffet-style feast or order together and share, just like the locals do üî• Grandma‚Äôs cooking at its finest üí∏ 30,000 - 50.000 VND max! üìç Where? Secret local spots (shared before we go) ‚è∞ When? a few times per week Come hungry, leave happy. Who‚Äôs in? üëá",
			location: { name: "T√ÇY H·ªí QU√ÅN", link: "https://maps.app.goo.gl/rxveR11i8ipk7361A" },
			category: "Food",
			frequency: "weekly",
			weekdays: []
		},

		{
			eventDate: "2025-04-13",
			eventTime: "3:00 PM",
			title: "üåç MUNDO LINGO üó£Ô∏è",
			details: "A place where people from all over the world come together, grab their language stickers at the door, and dive into a fun, laid-back evening. The stickers make it easy-peasy to approach anyone‚Äîjust spot your languages and start chatting! Whether you're here to practice, teach, or just have a good time, everyone‚Äôs welcome! Come for the languages, stay for the connections. See you there! üöÄ‚ú®",
			location: { name: "G·ªêM Garden Coffee", link: "https://maps.app.goo.gl/ZHpdB9kkHw5A3jD6A" },
			category: "Meetup",
			frequency: "weekly",
			weekdays: []
		},

		{
			eventDate: "2025-04-08",
			eventTime: "7:00 PM",
			title: "üíª The Weekly HACKATHON üöÄ",
			details: "Every Tuesday, we‚Äôre kicking off Da Nang‚Äôs ultimate hack night‚Äîcode, create, and collaborate in a chill, beer-fueled atmosphere. Whether you‚Äôre a coding wizard or just curious, this is the place to be. üí• The challenge? Build an app‚Äîuseful, fun, weird‚Ä¶ whatever! You can: ‚úÖ Hack along with Bo, who‚Äôll be sharing Cloud Atlas OS, a community-owned Google Maps that runs without servers. Whatever you imagine, we can bring it to a worldwide audience at zero cost. ‚úÖ Work on your own genius idea ‚úÖ Team up and jam on something crazy ‚úÖ Or just hang out, have a drink, and absorb the vibes ‚ö° Got a wild AI, Web3, or hacker project in mind? Drop it in the chat‚Äîwe might make it happen! Bring your laptop, grab a drink, and let‚Äôs build some next-level sh*t. üöÄüî• Who‚Äôs in? üëá",
			location: { name: " Icon Rooftop Restaurant - Danang Riverside", link: "https://maps.app.goo.gl/eQh7ge1hreRR7cMc7" },
			category: "Meetup",
			frequency: "weekly",
			weekdays: []
		},

		{
			eventDate: "2025-04-09",
			eventTime: "4:00 PM",
			title: "üåç THE NETWORK üå±üîó",
			details: "üåü Welcome to The Network ‚Äì A Global Networking Community with Hostless Local Meetings! üåü No matter what question, problem, or issue you have, there is a 99% chance that someone had already been through it and figured it out. That willingness to help each other is the best part of The Network. This beautiful and authentic event, born in Lisbon - Europe‚Äôs digital nomad haven - is now connecting solo travelers, digital nomads, and entrepreneurs across cities worldwide! ‚ù§Ô∏èüéâüôè üåç Goal: Empowering Connections & Cultivating Opportunities üöÄ üîó Expand your professional and social network üí° Exchange ideas, skills & opportunities üìö Learn from each other's experiences üîé Explore new places with like-minded people ü§ù Networking Opportunities: ‚úÖ Collaborate and share insights ‚úÖ Forge valuable connections ‚úÖ Grow Your Network What to Expect: Casual and Hostless: No formal hosts or schedules - just show up, meet fellow solo travelers, and decide as a group where the adventure takes you! Open to Everyone: Whether you‚Äôre a local or just passing through, all are welcome to join. How It Works: Arrive at the meeting spot at the scheduled time. Look for fellow The Network participants (ü•∑) - friendly faces and curious adventurers! Jump in‚Äîintroduce yourself, ask for help, or offer your expertise! üöÄ Decide as a group where to host yourself. (for instance we tried every week another location, sometimes bars, sometimes restaurants, sometimes a nice place in a park or on a beach, having BBQ. The possibilities are endless) ‚ú® Let‚Äôs make solo travel social, one city at a time. ‚ú® üîó Connect with us and let's grow together! üå±",
			location: { name: "Mia Food and Drink", link: "https://maps.app.goo.gl/yjarfNHnNCY9beM6A" },
			category: "Meetup",
			frequency: "weekly",
			weekdays: []
		},
	];

	let openIndex: number | null = null;
	let selectedCategory: string = "All";

	const toggle = (index: number) => {
		openIndex = openIndex === index ? null : index;
	};

	const getNextOccurrences = (event) => {
		const today = new Date();
		const nextOccurrences = [];
		const maxDays = 7;

		const addOccurrence = (date) => {
			const { eventDate, time, full } = splitDateAndTime(date.toISOString().split('T')[0], event.eventTime);
			nextOccurrences.push({ ...event, eventDate, eventTime: time, fullDate: full });
		};

		for (let i = 0; i <= maxDays; i++) {
			const currentDate = new Date(today);
			currentDate.setDate(today.getDate() + i);

			switch (event.frequency) {
				case 'once':
					if (new Date(event.eventDate).toDateString() === currentDate.toDateString()) {
						addOccurrence(currentDate);
					}
					break;
				case 'daily':
					if (event.weekdays.length === 0 || event.weekdays.includes(currentDate.toLocaleString('en-US', { weekday: 'long' }))) {
						addOccurrence(currentDate);
					}
					break;
				case 'weekly':
					if (event.weekdays.length === 0) {
						const startDate = new Date(event.eventDate);
						const daysDifference = Math.floor((currentDate - startDate) / (1000 * 60 * 60 * 24));
						if (daysDifference % 7 === 0) {
							addOccurrence(currentDate);
						}
					} else if (event.weekdays.includes(currentDate.toLocaleString('en-US', { weekday: 'long' }))) {
						addOccurrence(currentDate);
					}
					break;
				case 'monthly(same date)':
					if (event.eventDate.split('-')[2] === String(currentDate.getDate()).padStart(2, '0')) {
						addOccurrence(currentDate);
					}
					break;
				case 'monthly(same weekday)':
					if (event.weekdays.includes(currentDate.toLocaleString('en-US', { weekday: 'long' })) && new Date(event.eventDate).getDate() <= currentDate.getDate()) {
						addOccurrence(currentDate);
					}
					break;
			}
		}

		return nextOccurrences;
	};

	$: filteredEvents = (selectedCategory === "All"
		? events.flatMap(getNextOccurrences)
		: events.filter((e) => e.category === selectedCategory).flatMap(getNextOccurrences))
		.sort((a, b) => {
		const dateA = new Date(`${a.eventDate} ${a.eventTime}`);
		const dateB = new Date(`${b.eventDate} ${b.eventTime}`);
		if (dateA < dateB) return -1;
		if (dateA > dateB) return 1;
		return a.title.localeCompare(b.title);
	});

	const categories = ["All", ...new Set(events.map(e => e.category))];

	const splitDateAndTime = (dateStr: string, timeStr: string) => {
		const [hour, minutePart] = timeStr.split(':');
		const [minute, ampm] = minutePart.split(' ');
		let hours = parseInt(hour);
		if (ampm === 'PM' && hours !== 12) hours += 12;
		if (ampm === 'AM' && hours === 12) hours = 0;
		const date = new Date(dateStr);
		date.setHours(hours, parseInt(minute));
		const formattedTime = `${(hours % 12 || 12).toString().padStart(2, '0')}:${minute} ${ampm}`;
		const formattedDate = date.toLocaleDateString();
		const weekday = date.toLocaleString('en-US', { weekday: 'long' });
		return { eventDate: formattedDate, time: formattedTime, full: date, weekday };
	};

	const getCalendarLinks = (event) => {
		const { full: start } = splitDateAndTime(event.eventDate, event.eventTime);
		const end = new Date(start.getTime() + 60 * 60 * 1000); // +1 hour
		const format = (d: Date) => d.toISOString().replace(/[-:]|\.\d{3}/g, "");

		const title = encodeURIComponent(event.title);
		const details = encodeURIComponent(event.details);
		const location = encodeURIComponent(event.location.name);
		const dates = `${format(start)}/${format(end)}`;

		return {
			google: `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${dates}&details=${details}&location=${location}`,
			apple: `data:text/calendar;charset=utf8,BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
URL:${event.location.link}
DTSTART:${format(start)}
DTEND:${format(end)}
SUMMARY:${event.title}
DESCRIPTION:${event.details}
LOCATION:${event.location.name}
END:VEVENT
END:VCALENDAR`.replace(/\n/g, '%0A')
		};
	};
</script>

<main>
	<h1>GoDaNang.com</h1>

	<select bind:value={selectedCategory} style="margin-bottom: 20px;">
		{#each categories as category}
			<option value={category}>{category}</option>
		{/each}
	</select>

	<div class="event-container">
		{#each filteredEvents as event, index}
			<div class="event" on:click={() => toggle(index)}>
				<strong>{splitDateAndTime(event.eventDate, event.eventTime).weekday}, {splitDateAndTime(event.eventDate, event.eventTime).eventDate} {splitDateAndTime(event.eventDate, event.eventTime).time}</strong> - {event.title}
				{#if openIndex === index}
					<div class="details">
						<p>{event.details}</p>
						<p><strong>Location:</strong> <a href={event.location.link} target="_blank">{event.location.name}</a></p>
						<p><strong>Frequency:</strong> {event.frequency} {event.weekdays?.length ? `on ${event.weekdays.join(', ')}` : ''}</p>
						<div style="margin-top: 10px;">
							<a href={getCalendarLinks(event).apple} target="_blank">üçè Add to Apple Calendar</a><br>
							<a href={getCalendarLinks(event).google} target="_blank">üìÖ Add to Google Calendar</a>
						</div>
					</div>
				{/if}
			</div>
		{/each}
	</div>
</main>

<style>
	body {
		margin: 0;
		font-family: system-ui, sans-serif;
		color: white;
		background: #111;
	}

	main {
		padding: 2rem;
		text-align: center;
	}

	h1 {
		font-size: 3rem;
		margin-bottom: 1rem;
		background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
		background-size: 400% 400%;
		animation: gradient 10s ease infinite;
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
	}

	select {
		padding: 0.5rem;
		font-size: 1rem;
		margin-bottom: 1rem;
	}

	.event-container {
		max-width: 600px;
		margin: 0 auto;
	}

	.event {
		background: rgba(255,255,255,0.05);
		border: 1px solid rgba(255,255,255,0.1);
		border-radius: 12px;
		padding: 1rem;
		margin-bottom: 1rem;
		cursor: pointer;
	}

	.event:hover {
		background: rgba(255,255,255,0.1);
	}

	.details {
		margin-top: 0.5rem;
		text-align: left;
	}

	a {
		color: #90cdf4;
		text-decoration: none;
	}

	a:hover {
		text-decoration: underline;
	}

	@keyframes gradient {
		0% {background-position: 0% 50%;}
		50% {background-position: 100% 50%;}
		100% {background-position: 0% 50%;}
	}
</style>